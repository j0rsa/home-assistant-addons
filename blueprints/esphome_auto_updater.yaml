blueprint:
  name: "ESPHome Auto-Updater"
  description: "Automatically compile and update selected ESPHome devices when new versions are available"
  domain: automation

  input:
    update_entities:
      name: "ESPHome Update Entities"
      description: "Select the update entities for your ESPHome devices (update.device_name_firmware)"
      selector:
        entity:
          multiple: true
          filter:
            - domain: update
              integration: esphome
      default: []

    update_time_start:
      name: "Update Window Start (Optional)"
      description: "Only update devices after this time (leave empty for any time)"
      default: "02:00:00"
      selector:
        time:

    update_time_end:
      name: "Update Window End (Optional)"
      description: "Only update devices before this time (leave empty for any time)"
      default: "06:00:00"
      selector:
        time:

    enable_time_window:
      name: "Enable Time Window"
      description: "Only update devices within the specified time window"
      default: true
      selector:
        boolean:

    notify_before_update:
      name: "Notify Before Update"
      description: "Send notification before starting update"
      default: true
      selector:
        boolean:

    notification_service:
      name: "Notification Service (Optional)"
      description: "Service to use for notifications (e.g., notify.mobile_app_phone)"
      default: ""
      selector:
        text:

trigger:
  # Trigger when any selected update entity changes to 'on' (update available)
  - platform: state
    entity_id: !input update_entities
    to: "on"
    id: update_available

  # Trigger at the start of the update window to process pending updates
  - platform: time
    at: !input update_time_start
    id: window_start

condition: []

action:
  - variables:
      update_entities_list: !input update_entities
      time_window_enabled: !input enable_time_window
      window_start: !input update_time_start
      window_end: !input update_time_end
      notify_enabled: !input notify_before_update
      notification_svc: !input notification_service
      current_time: "{{ now().strftime('%H:%M:%S') }}"
      in_time_window: >
        {% if time_window_enabled %}
          {{ window_start <= current_time <= window_end }}
        {% else %}
          true
        {% endif %}

  - choose:
      # Triggered by window start time - process all pending updates
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'window_start' }}"
        sequence:
          - repeat:
              for_each: "{{ update_entities_list }}"
              sequence:
                - variables:
                    update_entity: "{{ repeat.item }}"
                    device_name: "{{ state_attr(repeat.item, 'friendly_name') | default(repeat.item.replace('update.', '').replace('_firmware', '')) }}"
                    installed_version: "{{ state_attr(repeat.item, 'installed_version') }}"
                    latest_version: "{{ state_attr(repeat.item, 'latest_version') }}"
                    has_update: "{{ states(repeat.item) == 'on' }}"

                # Only update if update is available
                - condition: template
                  value_template: "{{ has_update }}"

                # Send notification before update if enabled
                - if:
                    - condition: template
                      value_template: "{{ notify_enabled }}"
                  then:
                    - choose:
                        # Use custom notification service if provided
                        - conditions:
                            - condition: template
                              value_template: "{{ notification_svc != '' }}"
                          sequence:
                            - service: "{{ notification_svc }}"
                              data:
                                title: "ESPHome Update Starting"
                                message: "Updating {{ device_name }} from {{ installed_version }} to {{ latest_version }}"
                      # Fallback to persistent notification
                      default:
                        - service: persistent_notification.create
                          data:
                            title: "ESPHome Update Starting"
                            message: "Updating {{ device_name }} from {{ installed_version }} to {{ latest_version }}"
                            notification_id: "esphome_update_{{ update_entity | replace('.', '_') }}"

                # Trigger ESPHome update
                - service: update.install
                  target:
                    entity_id: "{{ update_entity }}"

                # Wait for update to complete (max 10 minutes)
                - wait_template: "{{ states(update_entity) == 'off' }}"
                  timeout: "00:10:00"
                  continue_on_timeout: true

                # Send completion notification if enabled
                - if:
                    - condition: template
                      value_template: "{{ notify_enabled }}"
                  then:
                    - choose:
                        # Use custom notification service if provided
                        - conditions:
                            - condition: template
                              value_template: "{{ notification_svc != '' }}"
                          sequence:
                            - service: "{{ notification_svc }}"
                              data:
                                title: "ESPHome Update Complete"
                                message: "{{ device_name }} has been updated to {{ latest_version }}"
                      # Fallback to persistent notification
                      default:
                        - service: persistent_notification.create
                          data:
                            title: "ESPHome Update Complete"
                            message: "{{ device_name }} has been updated to {{ latest_version }}"
                            notification_id: "esphome_update_{{ update_entity | replace('.', '_') }}"

                # Small delay between devices
                - delay:
                    seconds: 30

      # Triggered by state change - check if within window
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'update_available' }}"
        sequence:
          - variables:
              update_entity: "{{ trigger.entity_id }}"
              device_name: "{{ state_attr(trigger.entity_id, 'friendly_name') | default(trigger.entity_id.replace('update.', '').replace('_firmware', '')) }}"
              installed_version: "{{ state_attr(trigger.entity_id, 'installed_version') }}"
              latest_version: "{{ state_attr(trigger.entity_id, 'latest_version') }}"

          - choose:
            # Update is within time window - proceed with auto-update
            - conditions:
                - condition: template
                  value_template: "{{ in_time_window }}"
              sequence:
                # Send notification before update if enabled
                - if:
                    - condition: template
                      value_template: "{{ notify_enabled }}"
                  then:
                    - choose:
                        # Use custom notification service if provided
                        - conditions:
                            - condition: template
                              value_template: "{{ notification_svc != '' }}"
                          sequence:
                            - service: "{{ notification_svc }}"
                              data:
                                title: "ESPHome Update Starting"
                                message: "Updating {{ device_name }} from {{ installed_version }} to {{ latest_version }}"
                      # Fallback to persistent notification
                      default:
                        - service: persistent_notification.create
                          data:
                            title: "ESPHome Update Starting"
                            message: "Updating {{ device_name }} from {{ installed_version }} to {{ latest_version }}"
                            notification_id: "esphome_update_{{ update_entity | replace('.', '_') }}"

                # Trigger ESPHome update using the update entity's install service
                - service: update.install
                  target:
                    entity_id: "{{ update_entity }}"

                # Wait for update to complete (max 10 minutes)
                - wait_template: "{{ states(update_entity) == 'off' }}"
                  timeout: "00:10:00"
                  continue_on_timeout: true

                # Send completion notification if enabled
                - if:
                    - condition: template
                      value_template: "{{ notify_enabled }}"
                  then:
                    - choose:
                        # Use custom notification service if provided
                        - conditions:
                            - condition: template
                              value_template: "{{ notification_svc != '' }}"
                          sequence:
                            - service: "{{ notification_svc }}"
                              data:
                                title: "ESPHome Update Complete"
                                message: "{{ device_name }} has been updated to {{ latest_version }}"
                      # Fallback to persistent notification
                      default:
                        - service: persistent_notification.create
                          data:
                            title: "ESPHome Update Complete"
                            message: "{{ device_name }} has been updated to {{ latest_version }}"
                            notification_id: "esphome_update_{{ update_entity | replace('.', '_') }}"

            # Update is outside time window - notify and schedule for next window
            default:
              - if:
                  - condition: template
                    value_template: "{{ notify_enabled }}"
                then:
                  - choose:
                      # Use custom notification service if provided
                      - conditions:
                          - condition: template
                            value_template: "{{ notification_svc != '' }}"
                        sequence:
                          - service: "{{ notification_svc }}"
                            data:
                              title: "ESPHome Update Scheduled"
                              message: |
                                {{ device_name }} has an update available ({{ installed_version }} â†’ {{ latest_version }}). Update scheduled for {{ window_start }} tomorrow.
                    # Fallback to persistent notification
                    default:
                      - service: persistent_notification.create
                        data:
                          title: "ESPHome Update Scheduled"
                          message: |
                            **{{ device_name }}** has an update available but is outside the configured update window.
                            
                            Current version: {{ installed_version }}
                            Available version: {{ latest_version }}
                            
                            The update will be installed automatically at {{ window_start }} when the next update window opens.
                          notification_id: "esphome_update_pending_{{ update_entity | replace('.', '_') }}"

mode: single
max_exceeded: silent
